# 第1章 C# 和 `.NET` 框架

本章内容：在 `.NET` 之前、`.NET` 时代、编译成 CIL 、编译成本机代码并且执行、 CLR 、 CLI 、缩写回顾、 C# 的演化。

## 1.1 在 `.NET` 之前

C# 编程语言是为在微软公司的 `.NET` 框架上开发程序而设计的。

### 1.1.1 20 世纪 90 年代末的 Windows 编程

微软平台的 Windows 编程分化成很多分支：

* 大多数程序员使用的 Visual Basic 、 C 或者 C++ 。
* C 和 C++ 程序员使用纯 Win32 API ，大多数人使用的 MFC 。
* 有些人转向了 COM （组件对象模型）。

#### 缺点

* 纯 Win32 API 不是面向对象的，而且工作量巨大。
* MFC 是面向对象的，但是风格混乱并且陈旧。
* COM 虽然概念简单，但是实际代码很复杂，并且底层很丑陋凌乱。
* 这些技术都针对桌面程序而不是网络。

### 1.1.2 下一代平台服务的目标

需求： **<u>一个集成的、面向对象的开发框架，它可以把一致和优雅带回编程</u>** 。

#### 执行环境的目标

* 安全。
* 多平台。
* 性能。

#### 开发环境的目标

* 面向对象的开发环境；
* 一致的编程体验；
* 使用行业标准进行通信；
* 简化的部署；
* 语言独立；
* 互操作性；

## 1.2 `.NET` 时代

* 多平台：该系统可以在各种计算机上运行，从服务器、桌面机到 PDA ，还能在移动电话上运行。
* 行业标准：该系统使用行业标准的通信协议，比如 XML 、 HTTP 、 SOAP 、 JSON 和 WSDL 。
* 安全性：该系统能提供更加安全的执行环境，即使有来源可疑的代码存在。

### 1.2.1 `.NET` 框架的组成

`.NET` 框架由3部分组成。**执行环境称为 CLR （Common Language Runtime，公共语言运行库）。 CLR 在运行时管理程序的执行**，包括以下内容：

* **内存管理和垃圾收集**。
* **代码安全验证**。
* **代码执行、线程管理和异常处理**。

**BCL**（Basic Class Library，基类库）是 `.NET` 框架使用的一个大的类库，而且也可以在你的程序中使用。

### 1.2.2 大大改进的编程环境

1. **面向对象的开发环境**： CLR 、 BCL 和 C# 完全是面向对象的，并形成了良好的集成环境。

2. **自动收集垃圾**： CLR 有一项服务成为 GC ，它能为你自动管理内存。

3. **互操作性**： .NET 框架专门考虑了不同的 .NET 语言、操作系统或者 Win32 DLL 和 COM 之间的互操作性。

4. **不需要 COM**。

5. **简化部署**。

6. **类型安全性**： CLR 检查并且确保参数以及其他数据对象的类型安全，不同编程语言编写的组件之间也没有问题。

7. **基类库**： `.NET` 框架提供了一个庞大的基础类库，很自然的，它被称为基类库（Base Class Library）。在写自己的程序时，可以使用其中的类：
    1. 通用基础类：这些类可以应用到许多变成任务中，比如文件操作，字符串操作，安全和加密。
    2. 集合类：这些类实现了列表、字典、散列表以及位数组。
    3. 线程和同步类：这些类用于创建多线程程序。
    4. XML 类：这些类用于创建、读取以及操作 XML 文档。

## 1.3 编译成 CIL

**`.NET` 语言的编译器接受源代码文件，并生成名为程序集的输出文件** 。

* **<u>程序集要么是可执行的，要么是 `dll`</u>**。
* **<u>程序集里的代码并不是本机代码，而是 CIL（公共中间语言）</u>**。

## 1.4 编译成本机代码并且执行

**程序的 CIL 直到它被调用运行时才会被编译成本机代码**。

* 托管代码：为 `.NET` 框架编写的代码，需要 CLR 。
* 非托管代码：不在 CLR 控制之下运行的代码。

#### 编译和执行

**<u>C# 源文件 -> C# 编译器 -> 程序集（CIL ，类型信息）-> JIT 编译器（CLR 中）-> 本机代码</u>**

## 1.5 CLR

**<u>`.NET` 框架的核心组件是 CLR ，它在操作系统的顶层，负责管理程序的执行</u>**。

CLR 还提供以下的服务：

* **自动垃圾收集**；
* **安全和认证**；
* **通过访问 BCL 得到广泛的编程功能，包括 Web 服务和数据服务之类的功能**。

## 1.6 CLI

内置类型的特征因编程语言和平台的不同而不同。这种统一性的缺乏使得不同语言编写的程序以及库一起良好的协作。为了协作，必须有统一的标准。

**CLI（公共语言基础结构）**就是这样的一个标准，它把所有的 `.NET` 框架的组件连结成一个内聚的、一致的系统。它展示了系统的概念和架构，并详细说明了所有软件都必须坚持的规则和约定。

#### CLI 的组成部分

* 公共语言运行库（CLR）。
* 公共语言规范（CLS）。
* 基类库（BCL）。
* 元数据定义及语义。
* 公共类型系统（CTS）。
* 公共中间语言（CIL）指令组。

#### CLI 的重要组成部分

1. 公共类型系统（CTS）：定义了那些在托管代码中一定会使用的类型的特征。CTS最重要的特征之一是所有类型都继承自公共的基类 - `object`。
2. 公共语言规范（CLS）：详细说明了一个.NET兼容编程语言的规则，属性和行为，其主题包含数据类型、类结构和参数传递。

## 1.7 各种缩写



## 1.8 C# 的演化