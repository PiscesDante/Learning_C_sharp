# 第3章 类型、存储和变量

## 3.1 C#程序是一组类型声明

* C#程序或者DLL的源代码是一组一种或多种类型声明。
* 对于可执行程序，类型声明中必须有一个包含Main方法的类。
* 命名空间是一种**<u>把相关的类型声明分组并命名的方法</u>**。

例如，下面是一个由3个类型声明组成的程序。三个类型被声明在一个名为MyProgram的命名空间内部：

```C#
namespace MyProgram
{
    class DeclarationOfTypeA
    {
        
    }
    
    class DeclarationOfTypeB
    {
        
    }
    
    class C
    {
        static void Main() {
            // ...
        }
    }
}
```

## 3.2 类型是一种模板

既然C#程序是**<u>一组类型声明</u>**，那么学习C#就是学习如何创建和使用类型。

类型由下面的元素定义：

* 名称；
* 用于保存数据成员的数据结构；
* 一些行为及约束条件；

## 3.3 实例化类型

从某个类型模板创建实际的对象，称为实例化该类型。

* 通过实例化类型而创建的对象被称为类型的对象或者类型的实例。
* 在C#程序中，每个数据项都是某种类型的实例。

## 3.4 数据成员和函数成员

**类似`short`、`int`和`long`这样的类型称为简单类型。这种类型只能存储一个数据项**。

**其他的类型可以存储多个数据项。比如数组类型就可以存储多个同类型的数据项。这些数据项称为数组元素。可以通过数字来引用这些元素，这些数字称为索引**。

#### 成员的类别

另外一些类型可以包含许多不同类型的数据项。这些类型中的数据项个体称为**<u>成员</u>**，并且与数组中使用数字来引用成员不同，这些成员有自己的名称。

类中有两种成员：**<u>数据成员</u>**和**<u>函数成员</u>**：

* **<u>数据成员</u>**：保存了与这个累的对象或者作为一个整体的类相关的数据。
* **<u>函数成员</u>**：执行代码。函数成员定义类型的行为。

## 3.5 预定义类型

C#提供了16种内置类型，包括13种简单和3种非简单类型。所有内置类型的名称全都由小写字母组成。

* 11种数值类型；
* 1种Unicode字符类型char；
* 1种布尔类型bool；
* string类型，它是一个Unicode字符数组。
* object类型，它是所有其他类型的基类。
* dynamic，使用动态语言编写的程序集时使用。

## 3.6 用户定义类型

有6种类型可以由用户自己创建，它们是：

* 类类型（class）；
* 结构类型（struct）；
* 数组类型（array）；
* 枚举类型（enum）；
* 委托类型（delegate）；
* 接口类型（interface）；

类型通过类型声明创建，类型声明包含以下信息：

* 要创建的类型的种类；
* 新类型的名称；
* 对类型中每个成员的声明（名称和规格）。array和delegate类型除外，它们不含有命名成员；

使用用户定义类型是一个两部的过程：**<u>必须先声明类型，然后实例化该类型的对象</u>**。

## 3.7 栈和堆

**程序运行时，它的数据必须存储在内存中**。**<u>一个数据项需要多大的内存、存储在什么地方、以及如何存储都依赖于该数据项的类型</u>**。

运行时的程序使用两个内存区域来存储数据：**<u>栈</u>**和**<u>堆</u>**。

### 3.7.1 栈

栈是一个内存数组，是一个后进先出的数据结构。栈存储几种类型的数据：

* 某些类型变量的值；
* 程序当前的执行环境；
* 传递给方法的参数；

#### 栈的特征

* 数据只能从栈的顶端插入和删除。
* 把数据放到栈顶称为入栈（push）。
* 从栈顶删除数据称为出栈（pop）。

### 3.7.2 堆

堆是一块内存区域，在堆里可以分配大块的内存用于存储某类型的数据对象。

**<u>堆里的内存能够以任意顺序存入和移除</u>**。

## 3.8 值类型和引用类型

**数据项的类型**定义了**<u>存储数据需要的内存大小以及组成该类型的数据成员</u>**。类型还决定了对象在内存中的存储位置 - 栈或堆。

类型被分为两种：**<u>值类型</u>**和**<u>引用类型</u>**，这两种类型的对象在内存中的存储方式不同。

* 值类型只需要一段单独的内存，用于存储实际的数据（存放在栈内存里）。

* 引用类型需要两段内存：

    * 第一段存储实际的数据，这个数据总是位于堆中（堆内存）。
    * 第二段是一个引用，指向数据在堆中的存放位置（其实就是一个地址，存放在栈内存里）。

### 3.8.1 存储引用类型对象的成员

* **<u>引用类型对象的数据部分始终存放在堆里</u>**。
* 值类型对象，或引用类型数据的引用部分可以存放在堆里，也可以存放在栈里，这依赖于实际环境。

**<u>对于一个引用类型，其实例的数据部分始终被存放在堆内存里</u>**。既然两个成员都是对象数据的一部分，那么他们都会被存放在堆里，无论他们是值类型还是引用类型。

其实这里涉及到一个递归，**<u>只要是引用类型的数据部分，肯定是放在堆里面的</u>**；至于这个数据部分也许也有引用类型的数据，那么肯定也在被存放在堆里。

**<u>对于任何引用类型的任何对象，它所有的数据成员都存放在堆内存里，无论他们是值类型还是引用类型</u>**。

### 3.8.2 C#类型的分类

## 3.9 变量

**<u>变量是一个名称，表示程序执行时存储在内存中的数据</u>**。

C#提供了4种变量：

* **<u>本地变量</u>**：在方法的保存临时的数据，不是类型的成员。
* **<u>字段</u>**：保存和类型或者对象相关的数据，是类型的成员。
* **<u>参数</u>**：用于从一个方法到另一个方法传递数据的临时变量，不是类型的成员。
* **<u>数组元素</u>**：（通常是）同类数据项构成的有序集合的一个成员，可以为本地变量，也可以为类型的成员。

### 3.9.1 变量声明

变量在使用前必须声明。变量声明定义了变量，并完成两件事：

* 给变量命名，并为其关联一种类型；
* 让编译器为它分配一块内存。

**<u>一个简单的变量声明至少需要一个类型和一个名称</u>**。

声明一个变量的同时还能将其内存初始化为一个明确的值：**<u>变量初始化语句由一个等号后面跟一个初始值组成</u>**。

**<u>无初始化语句的本地变量有一个未定义的值，在未赋值之前变量不能使用</u>**。

**<u>一些类型的变量如果没有被显式的初始化，那么就会被设置为默认值</u>**。一般来说，本地变量不会被自动初始化。

### 3.9.2 多变量声明

可以把多个变量声明在一条单独的语句中，但是根本不提倡这种做法。

### 3.9.3 使用变量的值

变量名代表该变量保存的之，可以通过使用变量名来使用值。

## 3.10 静态类型和`dynamic`关键字

**<u>变量的类型在编译的时候确定并且不能在运行的时候修改，这样的类型就叫做静态类型</u>**。

C#语言中的dynamic关键字，**代表一个特定的、实际的C#类型，它知道如何在运行时解析自身**。

**<u>在编译时，编译器不会对dynamic类型的变量进行类型检查。编译器将与该变量以及该变量的操作有关的信息全部打包。在运行时，会对这些信息进行检查，以确保它与变量所代表的实际类型保持一致性。否则将抛出异常</u>**。

## 3.11 可空类型

**可空类型**<u>允许创建可以标记为有效或者无效的值类型，这样就可以在使用它之前确定值的有效性</u>。普通的值类型称作非可空类型。

